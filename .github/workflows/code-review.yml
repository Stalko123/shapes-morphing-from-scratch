name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs: 
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - name: Cache Ollama
      uses: actions/cache@v4
      with:
        path: |
          ~/.ollama
          /usr/local/bin/ollama
        key: ollama-${{ runner.os }}-${{ hashFiles('**/ollama-version') }}
        restore-keys: |
          ollama-${{ runner.os }}-
    
    - name: Install Ollama
      run: |
        if ! command -v ollama &> /dev/null; then
          echo "Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
        else
          echo "Ollama already installed"
        fi
      
    - name: Run Ollama
      run: |
        ollama serve &
        sleep 10
        if ! ollama list | grep -q "llama3.2:latest"; then
          echo "Pulling llama3.2:latest..."
          ollama pull llama3.2:latest
        else
          echo "llama3.2:latest already available"
        fi
        
    - name: Checkout pull request head
      id: checkout_per_head
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Code reviewing
      id: review
      run: |
        git checkout ${{ github.base_ref }}
        git pull
        git checkout ${{ github.head_ref }}
        
        echo "Reviewing Pull Request for branch $(git branch --show-current):"
        mycode=$(git diff ${{ github.base_ref }})
        
        review_output=$(ollama run llama3.2:latest 'Review this code: '"$mycode"', provide suggestions for improvment, coding best practices, improve readability, Give an overall rating: âœ… Looks good | âš ï¸ Needs attention | âŒ Needs major changes, Brief overview of what this PR does. Don'\''t provide any code, just the summary and the review, I want everything to be in markdown format with tables that summarizes the files changed and the changes made.')
        
        echo "$review_output" > /tmp/review.md
        
        {
          echo 'review<<EOF'
          cat /tmp/review.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
    - name: Comment on PR
      run: |
        # Read review content and escape for JSON
        REVIEW_CONTENT=$(cat /tmp/review.md | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        
        # Create JSON payload
        JSON_PAYLOAD=$(cat <<EOF
{
  "body": "## ðŸ¤– AI Code Review Summary\n\n${REVIEW_CONTENT}\n\n---\n*This review was generated automatically using Ollama (llama3.2)*"
}
EOF
)
        
        # Post comment using curl
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
          -d "$JSON_PAYLOAD"
