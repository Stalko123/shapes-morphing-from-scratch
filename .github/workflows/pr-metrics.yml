name: AI PR Summary
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir l'historique complet

      - name: Create required assets directory
        run: |
          mkdir -p ./assets
          echo "# Touch this file to install the latest version of Ollama." > ./assets/version-file.txt
          cat << 'EOF' > ./assets/prompt-file.txt
          You are an expert code reviewer with deep knowledge of software development practices.
          You have been given the output of the git diff command, which shows the differences between the original and modified versions of a set of files.
          Please review these changes and provide a structured code review, starting with the following statement: 'This is the code review from AI'.
          Then, for each file, list the filename as a bullet point and describe the changes in that file as sub-bullets under the filename.
          Focus on explaining the purpose of the changes, potential improvements, best practices, and any potential issues.
          The review should be professional, concise, and informative.
          Answer as quickly as possible in English language.
          Here is the git diff output for review:
          EOF
          echo "deepseek-coder-v2:latest" > ./assets/models-file.txt
          echo "magicoder:latest" >> ./assets/models-file.txt

      - name: Summarize PR with AI
        uses: behrouz-rad/ai-pr-summarizer@v1
        with:
          llm-model: 'deepseek-coder-v2:latest'
          prompt-file: ./assets/prompt-file.txt
          models-file: ./assets/models-file.txt
          version-file: ./assets/version-file.txt
          context-window: 4096
          upload-changes: true
          token: ${{ secrets.GITHUB_TOKEN }}
