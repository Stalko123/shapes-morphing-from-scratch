name: PR Summarizer

on:
  pull_request:

jobs:
  summarize-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1️⃣ Restore previously cached Ollama model if available
      - name: Download Ollama model artifact
        uses: actions/download-artifact@v4
        with:
          name: ollama-models
          path: ~/.ollama/models
        continue-on-error: true

      # 2️⃣ Install Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "✅ Ollama installed"

      # 3️⃣ Ensure llama3.2 model is installed
      - name: Ensure llama3.2 model is installed
        run: |
          export OLLAMA_MODELS="$HOME/.ollama/models"
          mkdir -p "$OLLAMA_MODELS"

          echo "🚀 Starting Ollama server..."
          ollama serve > /tmp/ollama.log 2>&1 &
          OLLAMA_PID=$!

          # Wait a bit longer for server
          sleep 10

          if ollama list 2>/dev/null | grep -q "llama3.2"; then
            echo "✅ llama3.2 model already available"
          else
            echo "📦 Pulling llama3.2:latest..."
            ollama pull llama3.2:latest || (echo "❌ Pull failed"; cat /tmp/ollama.log; exit 1)
          fi

          # Stop Ollama
          kill $OLLAMA_PID || true

          echo "📂 Models directory contents:"
          ls -Rlh "$OLLAMA_MODELS" || true

      # 4️⃣ Upload Ollama model for future runs
      - name: Upload Ollama model artifact
        if: success() && (hashFiles('~/.ollama/models/**') != '')
        uses: actions/upload-artifact@v4
        with:
          name: ollama-models
          path: ~/.ollama/models/**
          retention-days: 7

      # 5️⃣ Run summarizer using the model
      - name: Run PR Summarizer
        run: |
          ollama serve > /tmp/ollama.log 2>&1 &
          OLLAMA_PID=$!
          sleep 10
          
          echo "📝 Generating PR summary..."
          # Example prompt (replace with your own summarizer script)
          ollama run llama3.2:latest "Summarize this pull request." > pr-summary.txt
          
          kill $OLLAMA_PID || true
          cat pr-summary.txt
